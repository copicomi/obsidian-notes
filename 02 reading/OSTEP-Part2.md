[[OSTEP 操作系统导论]]
#reading #操作系统 

# 内存虚拟化

### 抽象：地址空间

**用户程序内的每个地址，都是虚拟的**

将硬件的物理地址，抽象成地址空间，以便用户使用

VM 的三个目的：
1. 透明
2. 效率
3. 保护

### 机制：地址转换

技术：动态重定位（基于硬件）
- 采用 `base` 和 `bound` 寄存器
- `physical address = virtual address + base`
- `base` 通过改变偏移量，来实现映射
- `bound` 通过界限，来防止非法访问内存

### 策略：分段

整块地分配内存，会产生大量内部浪费

因此，对逻辑地址分段，给每个段都分别**动态地**分配内存

分段不是等长的，这导致外部碎片的存在

空闲空间管理：
- 机制：分配与分割，记录空余块，合并块
- 策略：
	1. 最优匹配：最适合
	2. 最差匹配：最大
	3. 首次匹配：第一个可用
	4. 下次匹配：循环检查
	5. 分离空闲列表：面向请求类型，分类服务
	6. 伙伴系统：二叉树，节点合并

### 机制：分页

将空间分割成固定长度的分片，这就是分页的思想

> 分段是对存入数据的处理，分页是对内存空间的处理

灵活、简单

每个页自由地分配给虚拟地址，由 PFN 高位索引

页表存储在内存中，是 VPN 到 PFN 的映射

#### 时间优化：快速地址转化（TLB）

每次都从物理内存中读取，速度慢

采用缓存思想

替换策略：
1. 随机
2. LRU

#### 空间优化：页表

线性的页表占用空间过大

1. 分页和分段混合使用
	- 对页表动态地分配数据段
2. 多级页表
	- 采用树结构组织页表
	- 如果分页未使用，就不分配空间

### 机制：磁盘交换

检测，把页交换到磁盘，异常处理

## 策略：交换哪些页

1. FIFO
2. 随机
3. LRU 最少最近使用
4. 近似 LRU

脏页

