#reading 
#计算机网络 

# Chapter 6 链路层和局域网

## 6.1 链路层概述
在该层中，采用 *节点(node)* 和 *链路(link)* 描述对象

链路层中存在不同的链路层协议

---

### 6.1.1 链路层提供的服务
- 成帧（framing）
	- 链路层封装
- 链路接入
	- [[MAC]] 协议 规定了帧在链路上传输的规则
- 可靠交付
	- 保证数据无差错
	- 在高差错线路上有必要
	- 对于低差错线路，把这项服务交给运输层协议会更好
- 差错检测和纠正

---
### 6.1.2 链路层在何处实现

大部分功能在硬件中实现，通过 [[网络适配器]] 实现

---

## 6.2 差错检测和纠正技术

采用 差错检测和纠正比特（[[EDC]]）来增强数据 D

---
### 6.2.1 奇偶校验

单个奇偶校验位，面对偶数个差错，健壮性不足

二维奇偶校验：
- 把 D 分为 `i` 行 `j` 列，提供 `i+j` 个奇偶校验位
- 仅能纠正一位差错

接收方检测和纠错的能力，称为*前向纠错([[FEC]])*

FEC 减少了纠错所需的重传成本

---
### 6.2.2 检验和方法

将 d 位数据看作 k 位整数的序列处理，将 d/k 个整数相加，取反码作为 检验和校验码

---
### 6.2.3 循环冗余检测（[[CRC]]）

$D$ 代表原数据，$G$ 代表生成多项式
校验码 $R = D \mod G$ (XOR 运算下) 

---
## 6.3 多路访问链路和协议

两种类型的网络链路：
1. 点对点链路
2. 广播链路

> *多路访问问题*：
> 如何协调多个发送和接收节点对一个共享广播信道的访问？

当来自多个节点的广播信息发生 **碰撞（collide）** 时，有效信息会丢失，因此需要协议来协调多路访问

三类多路访问协议：
1. 信道划分协议
2. 随机接入协议
3. 轮流协议

一个良好协议的特点：
1. 利用率高（一个节点占全部）
2. 公平性好（多个节点分平均）
3. 去中心化
4. 实现简单

---
### 6.3.1 信道划分协议

[[TDM]] 和 [[FDM]] 是两种划分信道的方法

TDM 和 FDM 较为公平，但限制了单个节点的带宽上限

第三种方法是 [[CDMA]]，为每个节点分配特殊编码，抗干扰

---
### 6.3.2 [[随机接入协议]]

发生碰撞时，节点选择重传，为避免再次碰撞，节点会先等待一个随机时延后，再进行重传

#### 时隙 ALOHA

假设 节点分时进行同步传输

该协议中，每当碰撞发生，都有 `p` 的概率，选择立即重传，另外 `1-p` 的概率，选择在下一个时隙再决定是否重传

当存在多个节点时，重传后仍有可能发生碰撞
恰好只有一个节点在传输的时隙称为**成功时隙**，其占比定义为 该协议的**效率**

该协议的最大效率为 $\frac{1}{e} = 0.37$

---
#### ALOHA

纯 ALOHA 不考虑时隙，完全分散

其最大效率为 $\frac{1}{2e}$

---
#### 载波侦听多路访问（[[CSMA]]）

1. 先监听是否有其他节点在传输
2. 传输时，始终检测是否有其他节点在传输

---
#### 具有碰撞检测的载波监听多路访问（CSMA/CD）

该协议增加碰撞检测，当检测到碰撞时，相应的节点停止传输有误的数据

> 等待的随机时间，用 *二进制指数后退算法* ，每次传输失败，随机等待的时间上限就翻倍

效率定义为 **无碰撞传输时间** 的占比 

$d_{prop}$ 表示监听信号的传播时延，监听越敏感，碰撞越少
$d_{trans}$ 表示分组的传播时间，单个节点占用时间越长，碰撞越少

$$
效率 = \frac{1}{1 + 5d_{prop}/d_{trans}}
$$
---
### 6.3.3 轮流协议

轮询协议（polling protocol）：
- 指定主节点，循环轮询每个节点，通知其可进行传输
- 引入轮询时延，健壮性差

令牌传递协议（token-passing protocol）：
- 将特殊帧 token 以固定顺序在节点间传递

----
### 6.3.4 [[DOCSIS]]：用于电缆因特网接入的链路层协议

DOCSIS 用 **FDM** 为 上行和下行网络 划分信道

上行信道可能发生碰撞，因此又分时间间隔（类似**TDM**）

每个时间间隔内，又分为若干个微时隙，由 [[CMTS]] 为调制解调器 **集中分配** 传输时间

下层设备通过在特定的微时隙内，发送请求帧，来通知 CMTS 有信息要发送
这些请求帧可能发生碰撞，使用**随机接入**协议进行管理

---
## 6.4 交换局域网

### 6.4.1 链路层寻址和 [[ARP]]

#### MAC 地址

网络设备的适配器（即接口）具有一个链路层地址（MAC）

一般的 MAC 地址长度为 **6 字节**

为保证 MAC 地址不重复，生产公司在制造设备接口时，需要提前买下一块固定的地址空间

---
#### 地址解析协议（ARP）

链路层采用 ARP 获得目标主机的 MAC 地址，并封装进报文

每台主机或路由器，在内部维护一个 ARP 表，记录短期内的 IP 到 MAC 地址的映射

当 ARP 表没有要找的 MAC 时，sh 广播发送一个 *ARP分组* ，以询问子网上所有其他设备，获得 MAC 地址

ARP 既涉及 IP 地址，又涉及 MAC 地址，跨越两层 

---
#### 发送数据报到子网之外

通过网关路由器，进行 AS 间的数据传递
第一跳的目的 MAC 应当是网关路由器接口的 MAC

---
### 6.4.2 以太网

#### 以太网帧结构

以太网帧：
1. 前同步码
	- 用于同步 发送方 与 接收方 的时钟
2. 目的地址
	- 目的适配器的 MAC 地址
3. 源地址
	- 发送者的 MAC
4. 类型
	- 使用的网络层协议
5. 数据
	- 包含 IP 数据报的内容
	- 首部加数据，最多 1500字节
6. CRC
	- 校验

以太网提供不可靠服务，当检测到 CRC 错误，直接丢弃包，而不响应否定确认

---
#### 以太网技术

使用 点对点的 双绞铜线 或 光纤线缆 连接 链路层节点

---
### 6.4.3 链路层交换机

交换机负责接收入链路层帧，并转发到出链路

交换机对于子网中的网络设备是**透明的（transparent）**

---
#### 转发和过滤

该功能通过 *交换机表（switch table）* 完成

该表包含：
1. MAC 地址
2. 通向该 MAC 地址的交换机接口
3. 表项存在的时间

假设入端口为 x，交换机对待帧有三种处理：
1. 查表失败，将其广播到所有接口
2. 查表成功，发现出端口为 x，丢弃帧
3. 查表成功，发现出端口为 y，转发帧

---
#### 自学习

交换机表，是自动、动态和自治地建立的，是**自学习的**

该能力通过以下方式实现：
1. 初始表为空
2. 对待收到的入帧，记录三个信息：
	1. 源地址 MAC
	2. 该帧的到达接口
	3. 当前时间
3. 如果一段时间后没有再收到来自该 MAC 的帧，就把该表项删除

交换机是 *[[即插即用设备]]*

---
#### 链路层交换机的性质

相对于广播链路，交换机的优点：
1. 消除碰撞：点到点通信
2. 异质的链路：不同媒介通过交换机
3. 管理：安全，交换机自行检测异常

---
#### 交换机和路由器比较

交换机位于第二层，使用 MAC 地址进行转发
路由器位于第三次，使用 IP 地址进行转发

不过 路由器 也可使用 OpenFlow 转发 链路层帧

交换机：
1. 即插即用
2. 效率高
3. 健壮性差
4. 活跃拓扑限制为一棵生成树
5. ARP 协议产生额外流量

路由器：
1. 分层，拓扑结构更丰富
2. 路由选择，更灵活
3. 能够处理环路
4. 需要人工配置

---
### 6.4.4 虚拟局域网

交换机系统的缺点：
1. 缺乏流量隔离
2. 交换机的利用效率过低
3. 管理用户更加困难，必须修改物理布线

[[VLAN]] 可以处理以上问题

加入一台 支持 VLAN 的交换机，可以在一个单一的物理局域网上，定义多个虚拟局域网，实现流量隔离

要想修改配置，只需网络管理员手动修改 VLAN 即可

跨 VLAN 的通信，不能通过 原有共享的物理设施 进行，可以将两个 VLAN 接入同一台路由器，经路由器接口进行通信

---
采用 *VLAN 干线连接（VLAN trunking）*，用于添加 新的交换机 到已有 VLAN

在交换机上添加特殊的**干线接口**，专门用于连接外部 VLAN，同时在 以太网帧 中添加新的属性，指明将连接到的 VLAN

---
## 6.5 链路虚拟化：网络作为链路层

### 多协议标签交换

MPLS 引入固定长度标签，允许路由器根据该标签进行转发（而不是仅仅以 IP 地址为标准），该技术与 IP 协同工作

[[MPLS]] 在链路层帧 添加一个 MPLS 首部，该帧只能通过 MPLS 使能的路由器（称为*标签交换路由器*）交换

---

MPLS 的交换过程，不需考虑 IP 地址，加快了运行速度

但 MPLS 的优势不仅在于效率，还在于其潜在的 **流量管理能力**

通过对 MPLS 标签的配置，我们能够做到 **定制化** 数据转发的 路径，从而 **控制流量**

MPLS 也可以用于 实现 [[VPN]]，不采用路径最近的行为，而根据 MPLS 标签的配置，“人为地”选择绕远路，通过中间站 VPN 访问因特网

---
## 6.6 数据中心网络

数据中心的用途：
1. 提供内容服务
2. 用于特定数据处理任务的大规模并行计算
3. 为其他公司提供云计算服务
---
### 6.6.1 数据中心体系结构

在数据中心中，主机称为 *刀片（blade）* 
机架顶部的交换机称为 [[TOR]] 交换机

支持两种流量：
1. 内部流量
2. 外部流量
	- 用边界路由器，与因特网连接
---
#### 负载均衡

在数据中心内部，外部请求 首先被定向到一个 *负载均衡器（load balancer）*

负载均衡器的功能是，向主机分发请求，以均衡负载

同时还提供类似 [[NAT]] 的功能，提供 IP 转换，以防止用户直接接触主机

---
#### 等级体系结构

面对大规模的网络设备，采用 *路由器和交换机等级结构* 

等级分层式设计，降低网络的复杂度

设置大量冗余线路和冗余设备，以提供持续的可靠性服务

---
由于交换机的带宽有多台主机共享，因此主机到主机间的容量仍然受限

解决方案：
1. 部署更快的网络设备
2. 利用局部性，尽可能把相关的设备，放在物理距离更近的位置
3. 增强 TOR 交换机 与 高层次交换机 之间 的连接，增强 跨子网的 通信能力

这种设计使得**多路径路由**成为数据中心的首选技术

---

### 6.6.2 数据中心网络的发展趋势

#### 成本降低
优化交换机等级层次结构
#### 集中式 SDN 控制和管理
#### 虚拟化
采用 [[VM]] 技术，将软件和物理硬件解耦
#### 物理约束
部署针对化的拥塞控制协议
#### 硬件模块化和定制化
用集装箱构建数据中心，尽管降低性能，但黑盒模块，降低了维护的复杂度

---
## 6.7 回顾：Web 页面请求的历程

介绍下载一个 Web 网页的过程

---
### 6.7.1 准备：DHCP、UDP、IP和以太网

启动主机 host

用以太网电缆，将其连接到本地的以太网交换机

该交换机与一台路由器相连

该路由器又连接到本地的 ISP 

*物理操作结束*

---

host 的操作：
1. 运行 [[DHCP]] 协议
	- 发送 **DHCP 请求报文**
	- 报文被放入 **UDP 报文段**
	- UDP 报文被放入 广播 **IP 数据报**
2. IP 数据报 被放入 **以太网帧**，源地址为初始主机的 MAC 地址
3. 交换机，向所有出端口广播 带有 DHCP 请求的 以太网帧
4. 路由器接收到 该广播帧，从中抽取出 IP 数据报
	- 高层协议 又分解出 UDP 报文
	- DHCP 服务器 抽取出 DHCP 请求报文
5. DHCP 服务器采用 [[CIDR]] 分配地址，生成一个 DHCP ACK 报文，嵌套为 以太网帧 后发送回 host
6. 交换机转发给 host
7. host 收到 DHCP ACK，初始化 IP 地址与 DNS 服务器 IP 地址

---
### 6.7.2 仍在准备：DNS 和 ARP
8. 生成 **DNS查询报文** ，封装到 IP 数据报
9. 封装到链路层帧，为获取网关路由器的 MAC 地址，调用 **ARP协议**
10. 生成 **ARP查询报文**，交换器开始广播
11. 网关路由器收到查询，准备 **ARP回答**，发送回 host
12. host 收到回答，抽取出 目的MAC地址
13. host 将 DNS 查询报文 发送到网关路由器

---
### 6.7.3 仍在准备：域内路由选择到 DNS 服务器
14. 网关路由器收到该 IP 数据报，查找转发表，向外推出到另一个 AS
15. 中间路由器，通过 AS 内和 AS 间协议配置转发表，成功将 报文 送至 **DNS服务器**
16. DNS 服务器抽出 DNS 查询报文，从缓存中找到记录，生成 **DNS 回答报文**，发送回 host
17. host 收到目标网站的 IP 地址
---
### 6.7.4 Web 客户-服务器交互：TCP 和 HTTP

18. host 生成 TCP 套接字，与目标网站执行 **三次握手** ，发送 TCP SYN 报文
19. 报文 通过网络 发送到 目标服务器
20. 目标服务器 收到 SYN 报文，回复一个 TCP SYNACK 报文
21. host 收到 SYNACK 报文，建立 TCP 连接
22. host 发送一个 HTTP GET 报文
23. 服务器收到 GET 报文，回复一个 **HTTP响应报文**，返回网页内容
24. host 收到 响应报文，成功获得网页内容
---

