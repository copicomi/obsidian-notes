# 3.5 GFS 读文件（Read File)

有了之前的基础，我接下来会列出 GFS 读和写的步骤，最后，我会介绍出现故障之后，系统是如何保持正确的行为。

对于读请求来说，意味着应用程序或者 GFS 客户端有一个文件名和它想从文件的某个位置读取的偏移量（offset），应用程序会将这些信息发送给 Master 节点。Master 节点会从自己的 file 表单中查询文件名，得到 Chunk ID 的数组。因为每个 Chunk 是 64MB，所以偏移量除以 64MB 就可以从数组中得到对应的 Chunk ID。之后 Master 再从 Chunk 表单中找到存有 Chunk 的服务器列表，并将列表返回给客户端。所以，第一步是客户端（或者应用程序）将文件名和偏移量发送给 Master。第二步，Master 节点将 Chunk Handle（也就是 ID，记为 H）和服务器列表发送给客户端。

![](<../assets/image (241).png>)

现在客户端可以从这些 Chunk 服务器中挑选一个来读取数据。GFS 论文说，客户端会选择一个网络上最近的服务器（Google 的数据中心中，IP 地址是连续的，所以可以从 IP 地址的差异判断网络位置的远近），并将读请求发送到那个服务器。因为客户端每次可能只读取 1MB 或者 64KB 数据，所以，客户端可能会连续多次读取同一个 Chunk 的不同位置。所以，客户端会缓存 Chunk 和服务器的对应关系，这样，当再次读取相同 Chunk 数据时，就不用一次次的去向 Master 请求相同的信息。

![](<../assets/image (242).png>)

接下来，客户端会与选出的 Chunk 服务器通信，将 Chunk Handle 和偏移量发送给那个 Chunk 服务器。Chunk 服务器会在本地的硬盘上，将每个 Chunk 存储成独立的 Linux 文件，并通过普通的 Linux 文件系统管理。并且可以推测，Chunk 文件会按照 Handle（也就是 ID）命名。所以，Chunk 服务器需要做的就是根据文件名找到对应的 Chunk 文件，之后从文件中读取对应的数据段，并将数据返回给客户端。

![](<../assets/image (243).png>)

> 学生提问：可以再讲一下第一步吗？
>
> Robert 教授：第一步是，应用程序想读取某个特定文件的某个特定的偏移位置上的某段特定长度的数据，比如说第 1000 到第 2000 个字节的数据。所以，应用程序将文件名，长度和起始位置发送给 Master 节点。Master 节点会从其 file 表单中查询文件名并找到包含这个数据段的 Chunk，这样可以吗？
>
> 学生提问：如果读取的数据超过了一个 Chunk 怎么办？
>
> Robert 教授：我不知道详细的细节。我的印象是，如果应用程序想要读取超过 64MB 的数据，或者就是 2 个字节，但是却跨越了 Chunk 的边界，应用程序会通过一个库来向 GFS 发送 RPC，而这个库会注意到这次读请求会跨越 Chunk 边界，因此会将一个读请求拆分成两个读请求再发送到 Master 节点。所以，这里可能是向 Master 节点发送两次读请求，得到了两个结果，之后再向两个不同的 Chunk 服务器读取数据。
>
> 学生提问：如果客户端有偏移量信息，那可以直接算出来是第几个 Chunk 吧？

> Robert 教授：客户端可以算出来是哪个 Chunk，但是客户端不知道 Chunk 在哪个服务器上。为了获取服务器信息，客户端需要与 Master 交互。我不能保证究竟是在哪里决定的要读取的是第几个 Chunk。但是可以确定的是，Master 节点找到了 Chunk 对应的 ID，并确定了 Chunk 存储在哪个服务器上。
>
> 学生提问：能再介绍一下读数据跨越了 Chunk 边界的情况吗？
>
> Robert 教授：客户端本身依赖了一个 GFS 的库，这个库会注意到读请求跨越了 Chunk 的边界 ，并会将读请求拆分，之后再将它们合并起来。所以这个库会与 Master 节点交互，Master 节点会告诉这个库说 Chunk7 在这个服务器，Chunk8 在那个服务器。之后这个库会说，我需要 Chunk7 的最后两个字节，Chunk8 的头两个字节。GFS 库获取到这些数据之后，会将它们放在一个 buffer 中，再返回给调用库的应用程序。Master 节点会告诉库有关 Chunk 的信息，而 GFS 库可以根据这个信息找到应用程序想要的数据。应用程序只需要确定文件名和数据在整个文件中的偏移量，GFS 库和 Master 节点共同协商将这些信息转换成 Chunk。
>
> 学生提问：从哪个 Chunk 服务器读取数据重要吗？
>
> Robert 教授：是也不是。概念上讲，它们都是副本。实际上，你可能已经注意到，或者我们之前也说过，不同 Chunk 服务器上的数据并不一定完全相同。应用程序应该要能够容忍这种情况。所以，实际上，如果从不同的 Chunk 服务器读取数据，可能会略微不同。GFS 论文提到，客户端会尝试从同一个机架或者同一个交换机上的服务器读取数据。
