# 10.4 Aurora 初探

这一部分开始介绍 Aurora。整体上来看，我们还是有一个数据库服务器，但是这里运行的是 Amazon 提供的定制软件。所以，我可以向 Amazon 租用一个 Aurora 服务器，但是我不在上面运行我的软件，我租用了一个服务器运行 Amazon 的 Aurora 软件。这里只是一个实例，它运行在某个 AZ 中。

在 Aurora 的架构中，有两件有意思的事情：

第一个是，在替代 EBS 的位置，有 6 个数据的副本，位于 3 个 AZ，每个 AZ 有 2 个副本。所以现在有了超级容错性，并且每个写请求都需要以某种方式发送给这 6 个副本。这有些复杂，我们之后会再介绍。

![](<../assets/image (332).png>)

现在有了更多的副本，我的天，为什么 Aurora 不是更慢了，之前 Mirrored MySQL 中才有 4 个副本。答案是，这里通过网络传递的数据只有 Log 条目，这才是 Aurora 成功的关键。从之前的简单数据库模型可以看出，每一条 Log 条目只有几十个字节那么多，也就是存一下旧的数值，新的数值，所以 Log 条目非常小。然而，当一个数据库要写本地磁盘时，它更新的是 data page，这里的数据是巨大的，虽然在论文里没有说，但是我认为至少是 8k 字节那么多。所以，对于每一次事务，需要通过网络发送多个 8k 字节的 page 数据。而 Aurora 只是向更多的副本发送了少量的 Log 条目。因为 Log 条目的大小比 8K 字节小得多，所以在网络性能上这里就胜出了。这是 Aurora 的第一个特点，只发送 Log 条目。

当然，这里的后果是，这里的存储系统不再是通用（General-Purpose）存储，这是一个可以理解 MySQL Log 条目的存储系统。EBS 是一个非常通用的存储系统，它模拟了磁盘，只需要支持读写数据块。EBS 不理解除了数据块以外的其他任何事物。而这里的存储系统理解使用它的数据库的 Log。所以这里，Aurora 将通用的存储去掉了，取而代之的是一个应用定制的（Application-Specific）存储系统。

另一件重要的事情是，Aurora 并不需要 6 个副本都确认了写入才能继续执行操作。相应的，只要 Quorum 形成了，也就是任意 4 个副本确认写入了，数据库就可以继续执行操作。所以，当我们想要执行写入操作时，如果有一个 AZ 下线了，或者 AZ 的网络连接太慢了，或者只是服务器响应太慢了，Aurora 可以忽略最慢的两个服务器，或者已经挂掉的两个服务器，它只需要 6 个服务器中的任意 4 个确认写入，就可以继续执行。所以这里的 Quorum 是 Aurora 使用的另一个聪明的方法。通过这种方法，Aurora 可以有更多的副本，更多的 AZ，但是又不用付出大的性能代价，因为它永远也不用等待所有的副本，只需要等待 6 个服务器中最快的 4 个服务器即可。

![](<../assets/image (333).png>)

所以，这节课剩下的时间，我们会用来解释 Quorum 和 Log 条目。论文的表 1 总结了一些结果。Mirrored MySQL 将大的 page 数据发送给 4 个副本，而 Aurora 只是将小的 Log 条目发送给 6 个副本，Aurora 获得了 35 倍的性能提升。论文并没有介绍性能的提升中，有多少是 Quorum 的功劳，有多少是只发送 Log 条目的功劳，但是不管怎么样，35 倍的性能提升是令人尊敬的结果，同时也是对用户来说非常有价值的结果。我相信对于许多 Amazon 的客户来说，这是具有革新意义的。
