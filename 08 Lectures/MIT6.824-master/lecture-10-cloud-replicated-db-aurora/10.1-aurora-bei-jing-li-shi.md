# 10.1 Aurora 背景历史

今天的论文是 Amazon 的 Aurora。Aurora 是一个高性能，高可靠的数据库。Aurora 本身作为云基础设施一个组成部分而存在，同时又构建在 Amazon 自己的基础设施之上。

我们之所以要看这篇论文，有以下几个原因：

- 首先这是最近的来自于 Amazon 的一种非常成功的云服务，有很多 Amazon 的用户在使用它。Aurora 以自己的方式展示了一个聪明设计所取得的巨大成果。从论文的表 1 显示的与一些其他数据库的性能比较可以看出，在处理事务的速度上，Aurora 宣称比其他数据库快 35 倍。这个数字非常了不起了。
- 这篇论文同时也探索了在使用容错的，通用（General-Purpose）存储前提下，性能可以提升的极限。Amazon 首先使用的是自己的通用存储，但是后来发现性能不好，然后就构建了完全是应用定制（Application-Specific）的存储，并且几乎是抛弃了通用存储。
- 论文中还有很多在云基础设施世界中重要的细节。

因为这是 Amazon 认为它的云产品用户应该在 Amazon 基础设施之上构建的数据库，所以在讨论 Aurora 之前，我想花一点时间来回顾一下历史，究竟是什么导致了 Aurora 的产生？

![](<../assets/image (312).png>)

最早的时候，Amazon 提供的云产品是 EC2，它可以帮助用户在 Amazon 的机房里和 Amazon 的硬件上创建类似网站的应用。EC2 的全称是 Elastic Cloud 2。Amazon 有装满了服务器的数据中心，并且会在每一个服务器上都运行 VMM（Virtual Machine Monitor）。它会向它的用户出租虚拟机，而它的用户通常会租用多个虚拟机用来运行 Web 服务、数据库和任何其他需要运行的服务。所以，在一个服务器上，有一个 VMM，还有一些 EC2 实例，其中每一个实例都出租给不同的云客户。每个 EC2 实例都会运行一个标准的操作系统，比如说 Linux，在操作系统之上，运行的是应用程序，例如 Web 服务、数据库。这种方式相对来说成本较低，也比较容易配置，所以是一个成功的服务模式。

![](<../assets/image (313).png>)

这里有一个对我们来说极其重要的细节。因为每一个服务器都有一块本地的硬盘，在最早的时候，如果你租用一个 EC2 实例，每一个 EC2 实例会从服务器的本地硬盘中分到一小片硬盘空间。所以，最早的时候 EC2 用的都是本地盘，每个 EC2 实例会分到本地盘的一小部分。但是从 EC2 实例的操作系统看起来就是一个硬盘，一个模拟的硬盘。

![](<../assets/image (314).png>)

EC2 对于无状态的 Web 服务器来说是完美的。客户端通过自己的 Web 浏览器连接到一些运行了 Web 服务的 EC2 实例上。如果突然新增了大量客户，你可以立刻向 Amazon 租用更多的 EC2 实例，并在上面启动 Web 服务。这样你就可以很简单的对你的 Web 服务进行扩容。

另一类人们主要运行在 EC2 实例的服务是数据库。通常来说一个网站包含了一些无状态的 Web 服务，任何时候这些 Web 服务需要一些持久化存储的数据时，它们会与一个后端数据库交互。

所以，现在的场景是，在 Amazon 基础设施之外有一些客户端浏览器（C1，C2，C3）。之后是一些 EC2 实例，上面运行了 Web 服务，这里你可以根据网站的规模想起多少实例就起多少。这些 EC2 实例在 Amazon 基础设施内。之后，还有一个 EC2 实例运行了数据库。Web 服务所在的 EC2 实例会与数据库所在的 EC2 实例交互，完成数据库中记录的读写。

![](<../assets/image (315).png>)

不幸的是，对于数据库来说，EC2 就不像对于 Web 服务那样完美了，最直接的原因就是存储。对于运行了数据库的 EC2 实例，获取存储的最简单方法就是使用 EC2 实例所在服务器的本地硬盘。如果服务器宕机了，那么它本地硬盘也会无法访问。当 Web 服务所在的服务器宕机了，是完全没有问题的，因为 Web 服务本身没有状态，你只需要在一个新的 EC2 实例上启动一个新的 Web 服务就行。但是如果数据库所在的服务器宕机了，并且数据存储在服务器的本地硬盘中，那么就会有大问题，因为数据丢失了。

Amazon 本身有实现了块存储的服务，叫做 S3。你可以定期的对数据库做快照，并将快照存储在 S3 上，并基于快照来实现故障恢复，但是这种定期的快照意味着你可能会损失两次快照之间的数据。

所以，为了向用户提供 EC2 实例所需的硬盘，并且硬盘数据不会随着服务器故障而丢失，就出现了一个与 Aurora 相关的服务，并且同时也是容错的且支持持久化存储的服务，这个服务就是 EBS。EBS 全称是 Elastic Block Store。从 EC2 实例来看，EBS 就是一个硬盘，你可以像一个普通的硬盘一样去格式化它，就像一个类似于 ext3 格式的文件系统或者任何其他你喜欢的 Linux 文件系统。但是在实现上，EBS 底层是一对互为副本的存储服务器。随着 EBS 的推出，你可以租用一个 EBS volume。一个 EBS volume 看起来就像是一个普通的硬盘一样，但却是由一对互为副本 EBS 服务器实现，每个 EBS 服务器本地有一个硬盘。所以，现在你运行了一个数据库，相应的 EC2 实例将一个 EBS volume 挂载成自己的硬盘。当数据库执行写磁盘操作时，数据会通过网络送到 EBS 服务器。

![](<../assets/image (316).png>)

这两个 EBS 服务器会使用 Chain Replication（9.5）进行复制。所以写请求首先会写到第一个 EBS 服务器，之后写到第二个 EBS 服务器，然后从第二个 EBS 服务器，EC2 实例可以得到回复。当读数据的时候，因为这是一个 Chain Replication，EC2 实例会从第二个 EBS 服务器读取数据。

![](<../assets/image (317).png>)

所以现在，运行在 EC2 实例上的数据库有了可用性。因为现在有了一个存储系统可以在服务器宕机之后，仍然能持有数据。如果数据库所在的服务器挂了，你可以启动另一个 EC2 实例，并为其挂载同一个 EBS volume，再启动数据库。新的数据库可以看到所有前一个数据库留下来的数据，就像你把硬盘从一个机器拔下来，再插入到另一个机器一样。所以 EBS 非常适合需要长期保存数据的场景，比如说数据库。

对于我们来说，有关 EBS 有一件很重要的事情：这不是用来共享的服务。任何时候，只有一个 EC2 实例，一个虚机可以挂载一个 EBS volume。所以，尽管所有人的 EBS volume 都存储在一个大的服务器池子里，每个 EBS volume 只能被一个 EC2 实例所使用。

尽管 EBS 是一次很大的进步，但是它仍然有自己的问题。它有一些细节不是那么的完美。

- 如果你在 EBS 上运行一个数据库，那么最终会有大量的数据通过网络来传递。论文的图 2 中，就有对在一个 Network Storage System 之上运行数据库所需要的大量写请求的抱怨。所以，如果在 EBS 上运行了一个数据库，会产生大量的网络流量。在论文中有暗示，除了网络的限制之外，还有 CPU 和存储空间的限制。在 Aurora 论文中，花费了大量的精力来降低数据库产生的网络负载，同时看起来相对来说不太关心 CPU 和存储空间的消耗。所以也可以理解成他们认为网络负载更加重要。
- 另一个问题是，EBS 的容错性不是很好。出于性能的考虑，Amazon 总是将 EBS volume 的两个副本存放在同一个数据中心。所以，如果一个副本故障了，那没问题，因为可以切换到另一个副本，但是如果整个数据中心挂了，那就没辙了。很明显，大部分客户还是希望在数据中心故障之后，数据还是能保留的。数据中心故障有很多原因，或许网络连接断了，或许数据中心着火了，或许整个建筑断电了。用户总是希望至少有选择的权利，在一整个数据中心挂了的时候，可以选择花更多的钱，来保留住数据。 但是 Amazon 描述的却是，EC2 实例和两个 EBS 副本都运行在一个 AZ（Availability Zone）。

![](<../assets/image (318).png>)

在 Amazon 的术语中，一个 AZ 就是一个数据中心。Amazon 通常这样管理它们的数据中心，在一个城市范围内有多个独立的数据中心。大概 2-3 个相近的数据中心，通过冗余的高速网络连接在一起，我们之后会看一下为什么这是重要的。但是对于 EBS 来说，为了降低使用 Chain Replication 的代价，Amazon 将 EBS 的两个副本放在一个 AZ 中。
