# 15.6 File system recovering

接下来我们看一下发生在 XV6 的启动过程中的文件系统的恢复流程。当系统 crash 并重启了，在 XV6 启动过程中做的一件事情就是调用 initlog 函数。

![](<../assets/image (459).png>)

initlog 基本上就是调用 recover_from_log 函数。

![](<../assets/image (453).png>)

recover_from_log 先调用 read_head 函数从磁盘中读取 header，之后调用 install_trans 函数。这个函数之前在 commit 函数中也调用过，它就是读取 log header 中的 n，然后根据 n 将所有的 log block 拷贝到文件系统的 block 中。recover_from_log 在最后也会跟之前一样清除 log。

这就是恢复的全部流程。如果我们在 install_trans 函数中又 crash 了，也不会有问题，因为之后再重启时，XV6 会再次调用 initlog 函数，再调用 recover_from_log 来重新 install log。如果我们在 commit 之前 crash 了多次，在最终成功 commit 时，log 可能会 install 多次。

> 学生提问：如果一个进程向磁盘写了一些数据，但是在 commit 之前进程出现了故障，假设故障之后进程退出了，这样会有问题吗？
>
> Frans 教授：简单回答是没问题，因此磁盘不会被更新，所以效果就像文件系统操作没有发生过一样。并且进程并不能在故障后恢复，唯一能在故障之后还能保持的是保存在磁盘中的状态。（注，应该是没有理解问题。进程通过 write 系统调用成功写入的数据，就算在成功落盘之前进程异常退出了，内核还是会写入到磁盘中，前提是内核还在运行。）
