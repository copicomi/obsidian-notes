# 11.9 XV6 线程第一次调用 switch 函数

（注，首先是学生提问 Linux 内一个进程多个线程的实现方式，因为在 XV6 中，一个进程只有一个用户线程）

> 学生提问：操作系统都带了线程的实现，如果想要在多个 CPU 上运行一个进程内的多个线程，那需要通过操作系统来处理而不是用户空间代码，是吧？那这里的线程切换是怎么工作的？是每个线程都与进程一样了吗？操作系统还会遍历所有存在的线程吗？比如说我们有 8 个核，每个 CPU 核都会在多个进程的更多个线程之间切换。同时我们也不想只在一个 CPU 核上切换一个进程的多个线程，是吧？
>
> Robert 教授：Linux 是支持一个进程包含多个线程，Linux 的实现比较复杂，或许最简单的解释方式是：几乎可以认为 Linux 中的每个线程都是一个完整的进程。Linux 中，我们平常说一个进程中的多个线程，本质上是共享同一块内存的多个独立进程。所以 Linux 中一个进程的多个线程仍然是通过一个内存地址空间执行代码。如果你在一个进程创建了 2 个线程，那基本上是 2 个进程共享一个地址空间。之后，调度就与 XV6 是一致的，也就是针对每个进程进行调度。
>
> 学生提问：用户可以指定将线程绑定在某个 CPU 上吗？操作系统如何确保一个进程的多个线程不会运行在同一个 CPU 核上？要不然就违背了多线程的初衷了。
>
> Robert 教授：这里其实与 XV6 非常相似，假设有 4 个 CPU 核，Linux 会找到 4 件事情运行在这 4 个核上。如果并没有太多正在运行的程序的话，或许会将一个进程的 4 个线程运行在 4 个核上。或者如果有 100 个用户登录在 Athena 机器上，内核会随机为每个 CPU 核找到一些事情做。
>
> 如果你想做一些精细的测试，有一些方法可以将线程绑定在 CPU 核上，但正常情况下人们不会这么做。
>
> 学生提问：所以说一个进程中的多个线程会有相同的 page table？
>
> Robert 教授：是的，如果你在 Linux 上，你为一个进程创建了 2 个线程，我不确定它们是不是共享同一个的 page table，还是说它们是不同的 page table，但是内容是相同的。
>
> 学生提问：有没有原因说这里的 page table 要是分开的？
>
> Robert 教授：我不知道 Linux 究竟用了哪种方法。

（注，以下是线程第一次调用 switch 的过程）

> 学生提问：当调用 swtch 函数的时候，实际上是从一个线程对于 switch 的调用切换到了另一个线程对于 switch 的调用。所以线程第一次调用 swtch 函数时，需要伪造一个“另一个线程”对于 switch 的调用，是吧？因为也不能通过 swtch 函数随机跳到其他代码去。
>
> Robert 教授：是的。我们来看一下第一次调用 switch 时，“另一个”调用 swtch 函数的线程的 context 对象。proc.c 文件中的 allocproc 函数会被启动时的第一个进程和 fork 调用，allocproc 会设置好新进程的 context，如下所示：

![](<../assets/image (442).png>)

> 实际上大部分寄存器的内容都无所谓。但是 ra 很重要，因为这是进程的第一个 switch 调用会返回的位置。同时因为进程需要有自己的栈，所以 ra 和 sp 都被设置了。这里设置的 forkret 函数就是进程的第一次调用 swtch 函数会切换到的“另一个”线程位置。
>
> 学生提问：所以当 swtch 函数返回时，CPU 会执行 forkret 中的指令，就像 forkret 刚刚调用了 swtch 函数并且返回了一样？
>
> Robert 教授：是的，从 switch 返回就直接跳到了 forkret 的最开始位置。
>
> 学生提问：因吹斯听，我们会在其他场合调用 forkret 吗？还是说它只会用在这？
>
> Robert 教授：是的，它只会在启动进程的时候以这种奇怪的方式运行。下面是 forkret 函数的代码，

![](<../assets/image (422).png>)

> 从代码中看，它的工作其实就是释放调度器之前获取的锁。函数最后的 usertrapret 函数其实也是一个假的函数，它会使得程序表现的看起来像是从 trap 中返回，但是对应的 trapframe 其实也是假的，这样才能跳到用户的第一个指令中。
>
> 学生提问：与之前的 context 对象类似的是，对于 trapframe 也不用初始化任何寄存器，因为我们要去的是程序的最开始，所以不需要做任何假设，对吧？
>
> Robert 教授：我认为程序计数器还是要被初始化为 0 的。

![](<../assets/image (512).png>)

> 因为 fork 拷贝的进程会同时拷贝父进程的程序计数器，所以我们唯一不是通过 fork 创建进程的场景就是创建第一个进程的时候。这时需要设置程序计数器为 0。
>
> 学生提问：在 fortret 函数中，if(first)是什么意思？
>
> Robert 教授：文件系统需要被初始化，具体来说，需要从磁盘读取一些数据来确保文件系统的运行，比如说文件系统究竟有多大，各种各样的东西在文件系统的哪个位置，同时还需要有 crash recovery log。完成任何文件系统的操作都需要等待磁盘操作结束，但是 XV6 只能在进程的 context 下执行文件系统操作，比如等待 I/O。所以初始化文件系统需要等到我们有了一个进程才能进行。而这一步是在第一次调用 forkret 时完成的，所以在 forkret 中才有了 if(first)判断。
