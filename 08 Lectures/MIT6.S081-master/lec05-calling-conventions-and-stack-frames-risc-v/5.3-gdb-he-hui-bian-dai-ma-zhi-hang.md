# 5.3 gdb 和汇编代码执行

接下来我们来看一些真实的汇编代码。

![](<../assets/image (642).png>)

图中的代码，上半部分的注释是对应的 C 代码，这是个简单的函数，它累加了从 1 到 n 的所有数字，并返回结果。下半部分是可以编译出的最简单的汇编代码。如果你在你自己的计算机编写同样的 C 代码并编译，你得到的极有可能是差别较大的汇编代码。这里有很多原因，有一些原因我们之后会讲，有一些原因是因为编译器。当将 C 代码编译成汇编代码时，现代的编译器会执行各种各样的优化，所以你们自己编译得到的汇编代码可能看起来是不一样的。例如，当你在 gdb 中做 debug 的时候，有时候你会看到 gdb 提示你说某些变量被优化掉了，这意味着编译器决定了自己不再需要那个变量，变量以及相关的信息会在某个时间点删掉。

上图中的代码都很直观，首先将寄存器 a0 中的值保存在寄存器 t0 中。之后将寄存器 a0 设置为 0，之后在每个循环中将 t0 中的数据加到 a0 中，直到 t0 变成 0。这就是代码的所有内容。

> 学生提问：这里面.secion，.global，.text 分别是什么意思？
>
> TA：global 表示你可以在其他文件中调用这个函数。text 表明这里的是代码，如果你还记得 XV6 中的图 3.4，

![](<../assets/image (738).png>)

> 每个进程的 page table 中有一个区域是 text，汇编代码中的 text 表明这部分是代码，并且位于 page table 的 text 区域中。text 中保存的就是代码。

如果你对内核比较感兴趣，在编译完之后，你可以查看 kernel.asm 文件，你可以看到 XV6 完整内核的汇编版本。文件中每一行左边的数字表明的是这条指令会在内存中的哪个位置，这个信息非常有用。在汇编代码中还可以看到函数对应的 label，以及它们是在哪里定义的。这些信息在我们调试代码的时候可能会非常非常有用，我稍后会展示这部分。

> 学生提问：.asm 文件和.s 文件有什么区别？
>
> TA：我并不是百分百确定。这两类文件都是汇编代码，.asm 文件中包含大量额外的标注，而.s 文件中没有。所以通常来说当你编译你的 C 代码，你得到的是.s 文件。如果你好奇我们是如何得到.asm 文件，makefile 里面包含了具体的步骤。

现在回到函数 sum_to，我们看一下如何在 gdb 中检查这个函数。首先是要启动 QEMU，

![](<../assets/image (670).png>)

在另一个窗口打开 gdb，

![](<../assets/image (691).png>)

gdb 中输入 tui enable 可以打开源代码展示窗口。

sum_to 的代码现在都位于内核中，我在 sum_to 中设置一个断点。然后继续代码的执行，代码在断点处停住。

![](<../assets/image (773).png>)

gdb 窗口的左上角是程序计数器，我们可以看到当前的值是 0x800065e2。如果我们去 kernel.asm 中，查找这个地址，我们可以看到这个地址就是 sum_to 函数的起始地址。

![](<../assets/image (656).png>)

如果代码出现了问题，在 gdb 中看到的地址，你可以直接在 kernel.asm 找到具体的行，分析问题的原因，然后再向相应的地址设置断点。

在 gdb 中输入 layout asm，可以在 tui 窗口看到所有的汇编指令。再输入 layout reg 可以看到所有的寄存器信息。

![](<../assets/image (845).png>)

在寄存器窗口，可以看到 t0，a0 寄存器的值。在执行完一条汇编指令之后，t0 寄存器拥有了 a0 寄存器的内容，也就是 5。在寄存器窗口，更新了的寄存器会被高亮出来。

![](<../assets/image (752).png>)

之后持续的单步执行代码，直到函数返回。

如果你关心你设置了哪些断点，或着你跟踪代码的时候迷糊了，你可以在 gdb 中输入 info breakpoints，你可以看到所有设置了的断点。你甚至可以看到这个断点已经被命中了几次。

![](<../assets/image (704).png>)

类似的，你也可以通过输入 info reg 查看寄存器的信息。

> 学生提问：你是怎么打开多个 terminal 窗口的？
>
> TA：我是通过 tmux 打开的。（30:27 - 31:45 在介绍 tmux，与课程无关故跳过）
>
> 学生提问：为什么这里展示的是汇编代码而不是 C 代码？
>
> TA：从最初的代码可以看出，这里的程序完全是汇编代码实现的，所以自然也没有关联的 C 程序。如果我将断点设置在 C 代码中，在命中断点之后输入 layout split 或者 layout source，就可以看到相应的 C 代码了。
>
> layout split 会同时展现 C 代码和汇编，而 layout source 只会展示 C 代码。
>
> 学生提问：在 C 代码中，断点设置在某一行，如果这一行有多个语句的话，断点会设置在哪个语句？
>
> TA：断点会设置在第一个语句。

gdb 和 tmux 有上百个快捷指令，可以通过 google 去查找，对于 gdb，也可以使用 apropos 指令查看帮助。
