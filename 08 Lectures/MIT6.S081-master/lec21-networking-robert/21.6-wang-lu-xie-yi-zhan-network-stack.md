# 21.6 网络协议栈（Network Stack）

与 packet 的协议和格式对应的是运行在主机上的网络协议栈。人们有各种各样的方式来组织网络软件，接下来我会介绍最典型的，并且至少我认为是最标准的组织方式。

假设我们现在在运行 Linux 或者 XV6，我们有一些应用程序比如浏览器，DNS 服务器。这些应用程序使用 socket API 打开了 socket layer 的文件描述符。Socket layer 是内核中的一层软件，它会维护一个表单来记录文件描述符和 UDP/TCP 端口号之间的关系。同时它也会为每个 socket 维护一个队列用来存储接收到的 packet。我们在 networking lab 中提供的代码模板包含了一个非常原始的 socket layer。

![](<../assets/image (703).png>)

在 socket layer 之下是 UDP 和 TCP 协议层。UDP 软件几乎不做任何事情，它只是检查收到的 packet，获取目的端口号，并将 UDP payload 传输给 socket layer 中对应的队列。TCP 软件会复杂的多，它会维护每个 TCP 连接的状态，比如记录每个 TCP 连接的序列号，哪些 packet 没有被 ACK，哪些 packet 需要重传。所以 TCP 的协议控制模块会记录大量的状态，但是 UDP 中不会记录任何状态。UDP 和 TCP 通常被称为传输层。networking lab 提供的代码中有一个简单的 UDP 层，但是没有 TCP 的代码。

![](<../assets/image (644).png>)

在 TCP/UDP 之下是 IP 层，IP 层的软件通常很简单。虽然我不确定是在同一层还是下一层，与 IP 层在一起的还有 ARP 层。

![](<../assets/image (666).png>)

再往下的话，我们可以认为还会有一层以太网。但是通常并没有一个独立的以太网层。通常来说这个位置是一个或者多个网卡驱动，这些驱动与实际的网卡硬件交互。网卡硬件与局域网会有实际的连接。

![](<../assets/image (705).png>)

当一个 packet 从网络送达时，网卡会从网络中将 packet 接收住并传递给网卡驱动。网卡驱动会将 packet 向网络协议栈上层推送。在 IP 层，软件会检查并校验 IP header，将其剥离，再把剩下的数据向上推送给 UDP。UDP 也会检查并校验 UDP header，将其剥离，再把剩下的数据加入到 socket layer 中相应文件描述符对应的队列中。所以一个 packet 在被收到之后，会自底向上逐层解析并剥离 header。当应用程序发送一个 packet，会自顶向下逐层添加 header，直到最底层 packet 再被传递给硬件网卡用来在网络中传输。所以内核中的网络软件通常都是被嵌套的协议所驱动。

这里实际上我忘了一件重要的事情，在整个处理流程中都会有 packet buffer。所以当收到了一个 packet 之后，它会被拷贝到一个 packet buffer 中，这个 packet buffer 会在网络协议栈中传递。通常在不同的协议层之间会有队列，比如在 socket layer 就有一个等待被应用程序处理的 packet 队列，这里的队列是一个 linked-list。通常整个网络协议栈都会使用 buffer 分配器，buffer 结构。在我们提供的 networking lab 代码中，buffer 接口名叫 MBUF。

![](<../assets/image (646).png>)

以上就是一个典型的网络协议栈的分层图。
