# 21.3 二/三层地址转换 --- ARP

下一个与以太网通信相关的协议是 ARP。在以太网层面，每个主机都有一个以太网地址。但是为了能在互联网上通信，你需要有 32bit 的 IP 地址。为什么需要 IP 地址呢？因为 IP 地址有额外的含义。IP 地址的高位 bit 包含了在整个互联网中，这个 packet 的目的地在哪。所以 IP 地址的高位 bit 对应的是网络号，虽然实际上要更复杂一些，但是你可以认为互联网上的每一个网络都有一个唯一的网络号。路由器会检查 IP 地址的高 bit 位，并决定将这个 packet 转发给互联网上的哪个路由器。IP 地址的低 bit 位代表了在局域网中特定的主机。当一个经过互联网转发的 packet 到达了局域以太网，我们需要从 32bit 的 IP 地址，找到对应主机的 48bit 以太网地址。这里是通过一个动态解析协议完成的，也就是 Address Resolution Protocol，ARP 协议。

当一个 packet 到达路由器并且需要转发给同一个以太网中的另一个主机，或者一个主机将 packet 发送给同一个以太网中的另一个主机时，发送方首先会在局域网中广播一个 ARP packet，来表示任何拥有了这个 32bit 的 IP 地址的主机，请将你的 48bit 以太网地址返回过来。如果相应的主机存在并且开机了，它会向发送方发送一个 ARP response packet。

下图是一个 ARP packet 的格式：

![](<../assets/image (714).png>)

它会出现在一个以太网 packet 的 payload 中。所以你们看到的将会是这样的结构：首先是以太网 header，它包含了 48bit 的目的以太网地址，48bit 的源以太网地址，16bit 的类型；之后的以太网的 payload 会是 ARP packet，包含了上图的内容。

接收到 packet 的主机通过查看以太网 header 中的 16bit 类型可以知道这是一个 ARP packet。在 ARP 中类型值是 0x0806。通过识别类型，接收到 packet 的主机就知道可以将这个 packet 发送给 ARP 协议处理代码。

有关 ARP packet 的内容，包含了不少信息，但是基本上就是在说，现在有一个 IP 地址，我想将它转换成以太网地址，如果你拥有这个 IP 地址，请响应我。

同样的，我们也可以通过 tcpdump 来查看这些 packet。在网络的 lab 中，XV6 会在 QEMU 模拟的环境下发送 IP packet。所以你们可以看到在 XV6 和其他主机之间有 ARP 的交互。下图中第一个 packet 是我的主机想要知道 XV6 主机的以太网地址，第二个 packet 是 XV6 在收到了第一个 packet 之后，并意识到自己是 IP 地址的拥有者，然后返回 response。

![](<../assets/image (831).png>)

tcpdump 能够解析出 ARP packet，并将数据打印在第一行。对应 ARP packet 的格式，在第一个 packet 中，10.0.2.2 是 SIP，10.0.2.15 是 DIP。在第二个 packet 中，52:54:00:12:34:56 对应 SHA。

同时，我们也可以自己分析 packet 的原始数据。对于第一个 packet：

- 前 14 个字节是以太网 header，包括了 48bit 目的以太网地址，48bit 源以太网地址，16bit 类型。
- 从后往前看，倒数 4 个字节是 TIP，也就是发送方想要找出对应以太网地址的 IP 地址。每个字节对应了 IP 地址的一块，所以 0a00 020f 对应了 IP 地址 10.0.2.15。
- 再向前数 6 个字节，是 THA，也就是目的地的以太网地址，现在还不知道所以是全 0。
- 再向前数 4 个字节是 SIP，也就是发送方的 IP 地址，0a000202 对应了 IP 地址 10.0.2.2。
- 再向前数 6 个字节是 SHA，也就是发送方的以太网地址。
- 剩下的 8 个字节表明了我们感兴趣的是以太网和 IP 地址格式。

第二个 packet 是第一个 packet 的响应。

> 学生提问：ethernet header 中已经包括了发送方的以太网地址，为什么 ARP packet 里面还要包含发送方的以太网地址？
>
> Robert 教授：我并不清楚为什么 ARP packet 里面包含了这些数据，我认为如果你想的话是可以精简一下 ARP packet。或许可以这么理解，ARP 协议被设计成也可以用在其他非以太网的网络中，所以它被设计成独立且不依赖其他信息，所以 ARP packet 中包含了以太网地址。现在我们是在以太网中发送 ARP packet，以太网 packet 也包含了以太网地址，所以，如果在以太网上运行 ARP，这些信息是冗余的。但是如果在其他的网络上运行 ARP，你或许需要这些信息，因为其他网络的 packet 中并没有包含以太网地址。
>
> 学生提问：tcpdump 中原始数据的右侧是什么内容？
>
> Robert 教授：这些是原始数据对应的 ASCII 码，“.”对应了一个字节并没有相应的 ASCII 码，0x52 对应了 R，0x55 对应了 U。当我们发送的 packet 包含了 ASCII 字符时，这里的信息会更加有趣。

我希望你们在刚刚的讨论中注意到这一点，网络协议和网络协议 header 是嵌套的。我们刚刚看到的是一个 packet 拥有了 ethernet header 和 ethernet payload。在 ethernet payload 中，首先出现的是 ARP header，对于 ARP 来说并没有的 payload。但是在 ethernet packet 中还可以包含其他更复杂的结构，比如说 ethernet payload 中包含一个 IP packet，IP packet 中又包含了一个 UDP packet，所以 IP header 之后是 UDP header。如果在 UDP 中包含另一个协议，那么 UDP payload 中又可能包含其他的 packet，例如 DNS packet。所以发送 packet 的主机会按照这样的方式构建 packet：DNS 相关软件想要在 UDP 协议之上构建一个 packet；UDP 相关软件会将 UDP header 挂在 DNS packet 之前，并在 IP 协议之上构建另一个 packet；IP 相关的软件会将 IP heade 挂在 UDP packet 之前；最后 Ethernet 相关的软件会将 Ethernet header 挂在 IP header 之前。所以整个 packet 是在发送过程中逐渐构建起来的。

![](<../assets/image (821).png>)

类似的，当一个操作系统收到了一个 packet，它会先解析第一个 header 并知道这是 Ethernet，经过一些合法性检查之后，Ethernet header 会被剥离，操作系统会解析下一个 header。在 Ethernet header 中包含了一个类型字段，它表明了该如何解析下一个 header。同样的在 IP header 中包含了一个 protocol 字段，它也表明了该如何解析下一个 header。

![](<../assets/image (825).png>)

软件会解析每个 header，做校验，剥离 header，并得到下一个 header。一直重复这个过程直到得到最后的数据。这就是嵌套的 packet header。
