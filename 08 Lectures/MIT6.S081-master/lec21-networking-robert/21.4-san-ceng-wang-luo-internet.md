# 21.4 三层网络 --- Internet

Ethernet header 足够在一个局域网中将 packet 发送到一个 host。如果你想在局域网发送一个 IP packet，那么你可以使用 ARP 获得以太网地址。但是 IP 协议更加的通用，IP 协议能帮助你向互联网上任意位置发送 packet。下图是一个 IP packet 的 header，你们可以在 lab 配套的代码中的 net.h 文件找到。

![](<../assets/image (846).png>)

如果 IP packet 是通过以太网传输，那么你可以看到，在一个以太网 packet 中，最开始是目的以太网地址，源以太网地址，以太网类型是 0x0800，之后是 IP header，最后是 IP payload。

![](<../assets/image (725).png>)

在一个 packet 发送到世界另一端的网络的过程中，IP header 会被一直保留，而 Ethernet header 在离开本地的以太网之后会被剥离。或许 packet 在被路由的过程中，在每一跳（hop）会加上一个新的 Ethernet header。但是 IP header 从源主机到目的主机的过程中会一直保留。

IP header 具有全局的意义，而 Ethernet header 只在单个局域网有意义。所以 IP header 必须包含足够的信息，这样才能将 packet 传输给互联网上遥远的另一端。对于我们来说，关键的信息是三个部分，目的 IP 地址（ip_dst），源 IP 地址（ip_src）和协议（ip_p）。目的 IP 地址是我们想要将 packet 送到的目的主机的 IP 地址。地址中的高 bit 位是网络号，它会帮助路由器完成路由。IP header 中的协议字段会告诉目的主机如何处理 IP payload。

如果你们看到过 MIT 的 IP 地址，你们可以看到 IP 地址是 18.x.x.x，虽然最近有些变化，但是在很长一段时间 18 是 MIT 的网络号。所以 MIT 的大部分主机的 IP 地址最高字节就是 18。全世界的路由器在看到网络号 18 的时候，就知道应该将 packet 路由到离 MIT 更近的地方。

接下来我们看一下包含了 IP packet 的 tcpdump 输出。

![](<../assets/image (695).png>)

因为这个 IP packet 是在以太网上传输，所以它包含了以太网 header。呃……，实际上这个 packet 里面有点问题，我不太确定具体的原因是什么，但是 Ethernet header 中目的以太网地址不应该是全 f，因为全 f 是广播地址，它会导致 packet 被发送到所有的主机上。一个真实网络中两个主机之间的 packet，不可能出现这样的以太网地址。所以我提供的针对 network lab 的方案，在 QEMU 上运行有点问题。不管怎么样，我们可以看到以太网目的地址，以太网源地址，以及以太网类型 0x0800。0x0800 表明了 Ethernet payload 是一个 IP packet。

![](<../assets/image (805).png>)

IP header 的长度是 20 个字节，所以中括号内的是 IP header，

![](<../assets/image (853).png>)

从后向前看：

- 目的 IP 地址是 0x0a000202，也就是 10.0.2.2。
- 源 IP 地址是 0x0a00020f，也就是 10.0.2.15。
- 再向前有 16bit 的 checksum，也就是 0x3eae。IP 相关的软件需要检查这个校验和，如果结果不匹配应该丢包。
- 再向前一个字节是 protocol，0x11 对应的是 10 进制 17，表明了下一层协议是 UDP
- 其他的就是我们不太关心的一些字段了，例如 packet 的长度。

IP header 中的 protocol 字段告诉了目的主机的网络协议栈，这个 packet 应该被 UDP 软件处理。
