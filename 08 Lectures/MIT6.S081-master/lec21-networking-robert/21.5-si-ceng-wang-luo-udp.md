# 21.5 四层网络 --- UDP

IP header 足够让一个 packet 传输到互联网上的任意一个主机，但是我们希望做的更好一些。每一个主机都运行了大量需要使用网络的应用程序，所以我们需要有一种方式能区分一个 packet 应该传递给目的主机的哪一个应用程序，而 IP header 明显不包含这种区分方式。有一些其他的协议完成了这里的区分工作，其中一个是 TCP，它比较复杂，而另一个是 UDP。TCP 不仅帮助你将 packet 发送到了正确的应用程序，同时也包含了序列号等用来检测丢包并重传的功能，这样即使网络出现问题，数据也能完整有序的传输。相比之下，UDP 就要简单的多，它以一种“尽力而为”的方式将 packet 发送到目的主机，除此之外不提供任何其他功能。

UDP header 中最关键的两个字段是 sport 源端口和 dport 目的端口。

![](<../assets/image (855).png>)

当你的应用程序需要发送或者接受 packet，它会使用 socket API，这包含了一系列的系统调用。一个进程可以使用 socket API 来表明应用程序对于特定目的端口的 packet 感兴趣。当应用程序调用这里的系统调用，操作系统会返回一个文件描述符。每当主机收到了一个目的端口匹配的 packet，这个 packet 会出现在文件描述符中，之后应用程序就可以通过文件描述符读取 packet。

这里的端口分为两类，一类是常见的端口，例如 53 对应的是 DNS 服务的端口，如果你想向一个 DNS server 发请求，你可以发送一个 UDP packet 并且目的端口是 53。除此之外，很多常见的服务都占用了特定的端口。除了常见端口，16bit 数的剩下部分被用来作为匿名客户端的源端口。比如说，我想向一个 DNS server 的 53 端口发送一个 packet，目的端口会是 53，但是源端口会是一个本地随机选择的端口，这个随机端口会与本地的应用程序的 socket 关联。所以当 DNS server 向本地服务器发送一个回复 packet，它会将请求中的源端口拷贝到回复 packet 的目的端口，再将回复 packet 发送回本地的服务器。本地服务器会使用这个端口来确定应该将 packet 发送给哪个应用程序。

接下来我们看一下 UDP packet 的 tcpdump 输出。首先，我们同样会有一个以太网 Header，以及 20 字节的 IP header。IP header 中的 0x11 表明这个 packet 的 IP 协议号是 17，这样 packet 的接收主机就知道应该使用 UDP 软件来处理这个 packet。

![](<../assets/image (676).png>)

接下来的 8 个字节是 UDP header。这里的 packet 是由 lab 代码生成的 packet，所以它并没有包含常见的端口，源端口是 0x0700，目的端口是 0x6403。第 4-5 个字节是长度，第 6-7 个字节是校验和。XV6 的 UDP 软件并没有生成 UDP 的校验和。

![](<../assets/image (850).png>)

UDP header 之后就是 UDP 的 payload。在这个 packet 中，应用程序发送的是 ASCII 文本，所以我们可以从右边的 ASCII 码看到，内容是“a.message.from.xv6”。所以 ASCII 文本放在了一个 UDP packet 中，然后又放到了一个 IP packet 中，然后又放到了一个 Ethernet packet 中。最后发布到以太网上。

> 学生提问：当你发送一个 packet 给一个主机，但是你又不知道它的以太网地址，这个 packet 是不是会被送到路由器，之后再由路由器来找到以太网地址？
>
> Robert 教授：如果你发送 packet 到一个特定的 IP 地址，你的主机会先检查 packet 的目的 IP 地址来判断目的主机是否与你的主机在同一个局域网中。如果是的话，你的主机会直接使用 ARP 来将 IP 地址翻译成以太网地址，再将 packet 通过以太网送到目的主机。更多的场景是，我们将一个 packet 发送到互联网上某个主机。这时，你的主机会将 packet 发送到局域网上的路由器，路由器会检查 packet 的目的 IP 地址，并根据路由表选择下一个路由器，将 packet 转发给这个路由器。这样 packet 一跳一跳的在路由器之间转发，最终离目的主机越来越近。
>
> 学生提问：对于 packet 的长度有限制吗？
>
> Robert 教授：有的。这里有几个不同的限制，每一个底层的网络技术，例如以太网，都有能传输 packet 的上限。今天我们要讨论的论文基于以太网最大可传输的 packet 是 1500 字节。最新的以太网可以支持到 9000 或者 10000 字节的最大传输 packet。为什么不支持传输无限长度的 packet 呢？这里有几个原因：
>
> - 发送无限长度的 packet 的时间可能要很长，期间线路上会有信号噪音和干扰，所以在发送 packet 的时候可能会收到损坏的 bit 位。基本上每一种网络技术都会在 packet 中带上某种校验和或者纠错码，但是校验和也好，纠错码也好，只能在一定长度的 bit 位内稳定的检测错误。如果 packet 长度增加，遗漏错误的可能性就越来越大。所以一个校验和的长度，例如 16bit 或者 32bit，限制了传输 packet 的最大长度。
> - 另一个限制是，如果发送巨大的 packet，传输路径上的路由器和主机需要准备大量的 buffer 来接收 packet。这里的代价又比较高，因为较难管理一个可变长度的 buffer，管理一个固定长度的 buffer 是最方便的。而固定长度的 buffer 要求 packet 的最大长度不会太大。
>
> 所以，以太网有 1500 或者 9000 字节的最大 packet 限制。除此之外，所有的协议都有长度字段，例如 UDP 的长度字段是 16bit。所以即使以太网支持传输更大的 packet，协议本身对于数据长度也有限制。

以上就是 UDP 的介绍。在 lab 的最后你们会通过实验提供的代码来向谷歌的 DNS server 发送一个查询，收到回复之后代码会打印输出。你们需要在设备驱动侧完成以太网数据的处理。
