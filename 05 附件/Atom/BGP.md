[[边界网关协议]]，Broder Gatewat Protocol，[[BGP]]

---
---
## ISP 之间的路由选择：[[BGP]]

AS 内部采用 OSPF
AS 系统之间则需要一个 *[[自治系统间路由选择协议]]*

因特网中，为进行通信，所有 AS 必须运行相同的 AS 间路由选择协议，称为 *[[边界网关协议]]（BGP）*

---
### BGP 的作用

AS 内部，路由器直接寻址即可
而对于 AS 外部，路由器需要通过 BGP 进行连接

BGP 将分组路由到一个 [[CIDR]] 化的前缀，该前缀表示一个子网，或子网的集合

BGP 提供的功能：
1. 从邻居 AS 获取前缀的可达性信息
	- BGP 允许 AS 向整个因特网通告其存在
2. 确定到该前缀“最好的”路由

---
### 通告 BGP 路由信息

每个 AS 中，与外部 AS 相连的路由器称为 *网关路由器*，内部的则为 *内部路由器*

BGP 告知报文，带有寻找前缀 x 的路径信息，并迭代传递向下一个 AS

在实际运行中，并不存在 AS 到 AS 的直接连接，信息都是由路由器进行转发，将这种转发报文称为 *BGP连接*

跨 AS 的 BGP 连接称为 *外部 BGP（eBGP）*
相应的，也有*内部 BGP（iBGP）*

通过 BGP 连接，整个网络中的 每个路由器 都将得知 该 AS 的存在

不过传递的 BGP 报文，可能会包含不同的网络路径

---
### 确定最好的路由

如何确定选择哪个 BGP 路径呢，并配置转发表呢？

BGP 报文中包含一些 *BGP属性 (attribute)* ，前缀及其属性用 BGP 术语称为 *路由 (route)*

> 两个重要属性
> 1. AS-PATH ：
> 	记录已经通过的 AS 列表，检测并拒绝环路
> 2. NEXT-TOP ：
> 	 AS-PATH 的起始路由器接口的 IP 地址
> 	 用于指示下一跳的 IP
> 3. AS 的 IP 前缀

---
#### 热土豆路由选择（hot potato routing）

路由器更新转发表的工作流程：
1. 根据 AS 间协议，学习到 当前可以到达另一个子网 `x`
2. 根据 AS 内部协议，计算到达本 AS 各网关的最低开销
3. 选择 开销最低的 网关 `q`
4. 确定通往 `q` 的出口端口 `I`，将 `(x, I)` 加入转发表

这种想法，只考虑如何快速把分组传递到 AS 边缘，而不考虑全局的开销，分组被类比为烫手的热土豆

---

#### 路由器选择算法

该算法按以下规则判断：（优先级从高到低）
1. 添加 *本地偏好* 属性值，选择优先级最高的
	- 该属性可从其他路由器学习，也可由管理员手动配置，这是一种策略决定
2. 选择 AS-PATH 最短的
3. 采用热土豆选择
4. 采用 BGP 标识符来选择

一定程度上考虑了全局最优

---
### IP 任播（anycast）

BGP 常用于实现 IP 任播，该服务通常用于 DNS 中

应用情景：
1. 在分散的不同位置的不同服务器上，替换相同内容
2. 让每个用户从最接近的服务器访问内容

工作过程：
1. 配置阶段：
	- 为多台服务器指派相同的 IP 地址（内容等效）
	- 同时从多个起点进行  BGP 通告
	- 遇到的 BGP 路由器会把 这些物理位置不同的服务器 等效为 同一个 IP 地址，进行路由表的维护
2. 请求阶段：
	- 直接访问路由器上存储的最短路径即可

---
### 路由选择策略

当某个 网络节点 X ，不愿存在通过 X 进行转发的流量（如多宿 ISP）

此时 X 可选择不向其邻居 通告 距离向量，通过人为设定 *BGP 本地偏好属性* 实现

不同的 ISP 之间，不希望来自对方的流量 能够 搭便车，因此都会通过协商来限制流量通过

---